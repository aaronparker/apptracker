# Separate workflow so that we can update docs without running the update-json workflow
name: 'Update docs'

# Environment variables
env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# Controls when the action will run. 
on:
  workflow_run:
    workflows: ['Update apps', 'Update self-hosted']
    types:
      - completed
  workflow_dispatch:

jobs:
  update-docs:
      runs-on: ubuntu-latest
      if: ${{ github.event.workflow_run.conclusion == 'success' }}

      steps:
        - uses: actions/checkout@v5
          with:
            ref: main
            token: ${{ secrets.PAT }}

        - name: Git pull
          shell: pwsh
          run: |
            git config --global core.safecrlf false
            git pull origin main

        - name: Download changed files artifacts
          uses: actions/download-artifact@v5
          with:
            pattern: changed-files-*
            path: artifacts
            merge-multiple: true
          continue-on-error: true

        - name: Process changed files list
          id: changed-files
          shell: pwsh
          run: |
            $ChangedFiles = @()
            
            # Check for artifacts from both workflows
            $ArtifactFiles = @("artifacts/changed-files-pwsh.txt", "artifacts/changed-files-hosted.txt")
            
            foreach ($File in $ArtifactFiles) {
              if (Test-Path -Path $File) {
                $Content = Get-Content $File -ErrorAction SilentlyContinue
                if ($Content -and $Content -ne "No files changed") {
                  $ChangedFiles += $Content
                }
                Write-Host "Found artifact: $File with content: $($Content -join ', ')"
              }
            }
            
            # Remove duplicates and filter to json files only
            $UniqueFiles = $ChangedFiles | Where-Object { $_ -like "*.json" } | Select-Object -Unique
            
            if ($UniqueFiles) {
              $UniqueFiles | Out-File -FilePath "combined-changed-files.txt" -Encoding "Utf8" -Force
              Write-Host "Combined changed files: $($UniqueFiles -join ', ')"
              echo "has-changes=true" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append
            } else {
              Write-Host "No changed files found in artifacts"
              echo "has-changes=false" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append
            }

        - name: Install modules
          shell: pwsh
          run: |
            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
            Get-PSResourceRepository | Set-PSResourceRepository -Trusted
            Install-PSResource -Name "MarkdownPS" 
            Install-PSResource -Name "Evergreen" -Prerelease
            Update-Evergreen

        - name: Generate report
          shell: pwsh
          run: |
            $params = @{
              JsonPath    = "${{ github.workspace }}/json"
              OutputPath  = "${{ github.workspace }}/docs/_apps"
              IndexFile   = "${{ github.workspace }}/docs/index.md"
            }
            
            # Add changed files if available
            if (Test-Path "combined-changed-files.txt") {
              $ChangedFiles = Get-Content "combined-changed-files.txt"
              if ($ChangedFiles) {
                $params["ChangedFiles"] = $ChangedFiles
                Write-Host "Passing $($ChangedFiles.Count) changed files to New-Report.ps1"
              }
            }
            
            . "${{ github.workspace }}/scripts/New-Report.ps1" @params

        # Format the date number for the commit message
        - name: Get date
          id: get-date
          run: |
            DATEF=`date +%Y.%m.%d`
            echo "date=$DATEF" >> $GITHUB_OUTPUT

        # Import GPG key
        - name: Import GPG key
          id: import_gpg
          uses: crazy-max/ghaction-import-gpg@v6
          with:
            gpg_private_key: ${{ secrets.GPGKEY }}
            passphrase: ${{ secrets.GPGPASSPHRASE }}
            git_user_signingkey: true
            git_commit_gpgsign: true
            git_config_global: true
            git_tag_gpgsign: true
            git_push_gpgsign: false
            git_committer_name: ${{ secrets.COMMIT_NAME }}
            git_committer_email: ${{ secrets.COMMIT_EMAIL }}

        - name: Commit changes
          id: commit
          uses: stefanzweifel/git-auto-commit-action@v7
          with:
            commit_message: "Update docs ${{ steps.get-date.outputs.date }}.${{ github.run_number }} ${{ github.job }}"
            commit_user_name: ${{ secrets.COMMIT_NAME }}
            commit_user_email: ${{ secrets.COMMIT_EMAIL }}

        - name: "Run if changes have been detected"
          if: steps.commit.outputs.changes_detected == 'true'
          run: echo "Changes committed."

        - name: "Run if no changes have been detected"
          if: steps.commit.outputs.changes_detected == 'false'
          run: echo "No changes detected."
