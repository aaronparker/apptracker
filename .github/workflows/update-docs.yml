# Separate workflow so that we can update docs without running the update-json workflow
name: 'Update docs'

# Environment variables
env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# Controls when the action will run. 
on:
  workflow_run:
    workflows: ['Update apps', 'Update self-hosted']
    types:
      - completed
  workflow_dispatch:

jobs:
  update-docs:
      runs-on: ubuntu-latest
      if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run && github.event.workflow_run.conclusion == 'success') }}

      steps:
        - uses: actions/checkout@v6
          with:
            ref: main
            token: ${{ secrets.PAT }}

        - name: Git pull
          shell: pwsh
          run: |
            git config --global core.safecrlf false
            git pull origin main

        - name: Query changed JSON files via GitHub API
          id: changed-files
          shell: pwsh
          run: |
            $ChangedFiles = @()
            $JsonDir = "json"
            
            # Get all JSON files in the json directory
            $AllJsonFiles = Get-ChildItem -Path "${{ github.workspace }}/$JsonDir" -Filter "*.json" -File | Select-Object -ExpandProperty Name
            Write-Host "Found $($AllJsonFiles.Count) total JSON files"
            
            # For each JSON file, get the last commit that modified it
            foreach ($JsonFile in $AllJsonFiles) {
              try {
                # Get the most recent commit for this file
                $commitInfo = & git log -1 --format="%H|%aI" -- "$JsonDir/$JsonFile"
                
                if ($commitInfo) {
                  $parts = $commitInfo -split '\|'
                  $commitHash = $parts[0]
                  $commitDate = $parts[1]
                  
                  # Add to changed files list
                  $ChangedFiles += "$JsonDir/$JsonFile"
                  Write-Host "Found JSON file: $JsonDir/$JsonFile (last modified: $commitDate)"
                } else {
                  Write-Host "No commit history found for $JsonDir/$JsonFile"
                }
              } catch {
                Write-Host "Error querying commit info for $JsonDir/$JsonFile : $_"
              }
            }
            
            # Output the changed files
            if ($ChangedFiles.Count -gt 0) {
              $ChangedFiles | Out-File -FilePath "combined-changed-files.txt" -Encoding "Utf8" -Force
              Write-Host "Found $($ChangedFiles.Count) changed JSON files"
              echo "has-changes=true" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append
            } else {
              Write-Host "No JSON files found in json directory"
              echo "has-changes=false" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append
            }

        - name: Install modules
          shell: pwsh
          run: |
            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
            Get-PSResourceRepository | Set-PSResourceRepository -Trusted
            Install-PSResource -Name "MarkdownPS" 
            Install-PSResource -Name "Evergreen" -Prerelease
            Update-Evergreen

        - name: Generate report
          shell: pwsh
          run: |
            $params = @{
              JsonPath    = "${{ github.workspace }}/json"
              OutputPath  = "${{ github.workspace }}/docs/_apps"
              IndexFile   = "${{ github.workspace }}/docs/index.md"
            }
            
            # Add changed files if available
            if (Test-Path "combined-changed-files.txt") {
              $ChangedFiles = Get-Content "combined-changed-files.txt"
              if ($ChangedFiles) {
                $params["ChangedFiles"] = $ChangedFiles
                Write-Host "Passing $($ChangedFiles.Count) changed files to New-Report.ps1"
              }
            }
            
            . "${{ github.workspace }}/scripts/New-Report.ps1" @params

        # Format the date number for the commit message
        - name: Get date
          id: get-date
          run: |
            DATEF=`date +%Y.%m.%d`
            echo "date=$DATEF" >> $GITHUB_OUTPUT

        # Import GPG key
        - name: Import GPG key
          id: import_gpg
          uses: crazy-max/ghaction-import-gpg@v6
          with:
            gpg_private_key: ${{ secrets.GPGKEY }}
            passphrase: ${{ secrets.GPGPASSPHRASE }}
            git_user_signingkey: true
            git_commit_gpgsign: true
            git_config_global: true
            git_tag_gpgsign: true
            git_push_gpgsign: false
            git_committer_name: ${{ secrets.COMMIT_NAME }}
            git_committer_email: ${{ secrets.COMMIT_EMAIL }}

        - name: Commit changes
          id: commit
          uses: stefanzweifel/git-auto-commit-action@v7
          with:
            commit_message: "Update docs ${{ steps.get-date.outputs.date }}.${{ github.run_number }} ${{ github.job }}"
            commit_user_name: ${{ secrets.COMMIT_NAME }}
            commit_user_email: ${{ secrets.COMMIT_EMAIL }}
